# ==========================
#  Etapa 1: Compilaci贸n
# ==========================
FROM node:20-alpine AS builder
WORKDIR /app

# Copia solo los archivos de dependencias para aprovechar cach茅
COPY package*.json ./
RUN npm ci  # Instala todas las dependencias (incluyendo devDependencies)

# Copia el resto del c贸digo
COPY . .

# Compila el c贸digo (por ejemplo, si usas TypeScript o Webpack)
RUN npm run build

# ==========================
#  Etapa 2: Producci贸n
# ==========================
FROM node:20-alpine
WORKDIR /app

# Variables de entorno (opcional)
#ENV NODE_ENV=production

# Copia solo los archivos de dependencias y las instala sin devDependencies
COPY package*.json ./
RUN npm ci --omit=dev  # Instala solo dependencias de producci贸n

# Copia SOLO el c贸digo compilado desde la etapa anterior
COPY --from=builder /app/dist ./dist

# Opcional: Usuario sin privilegios para mayor seguridad
#RUN addgroup -S appgroup && adduser -S appuser -G appgroup
#USER appuser

# Expone el puerto en el que corre la aplicaci贸n
EXPOSE 8080

# Comando de inicio de la app
CMD ["node", "dist/srv.js"]
